services:
  glacier-dashboard:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: glacier-manager
    image: glacier-manager:latest

    ports:
      - "8080:8080"

    volumes:
      # AWS credentials (read-only)
      - ~/.aws:/home/glacier/.aws:ro

      # Mount data directory to sync all files
      # (job_*.json, inventories, logs, etc.)
      - ../data:/home/glacier/app/data:rw

    working_dir: /home/glacier/app

    environment:
      # AWS configuration (optional, can also use credentials from volume)
      - AWS_REGION=eu-west-1
      - AWS_DEFAULT_REGION=eu-west-1
      # Uncomment if you want to use environment variables for credentials
      # - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      # - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}

    restart: unless-stopped

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/api/status"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

    # Resource limits (optional)
    deploy:
      resources:
        limits:
          cpus: '2'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 256M

    # Logging
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# Create dedicated network (optional)
networks:
  default:
    name: glacier-network
